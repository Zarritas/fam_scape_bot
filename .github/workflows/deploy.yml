name: Deploy

on:
  push:
    branches: [production]
  workflow_dispatch:

env:
  VPS_HOST: ${{ secrets.VPS_HOST }}
  VPS_USER: ${{ secrets.VPS_USER }}
  VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}

jobs:
  deploy:
    name: Deploy to IONOS VPS
    runs-on: ubuntu-latest
    environment: production

    steps:
      - uses: actions/checkout@v4

      - name: Deploy to IONOS VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.VPS_HOST }}
          username: ${{ env.VPS_USER }}
          key: ${{ env.VPS_SSH_KEY }}
          port: 22
          timeout: 30s
          debug: true
          script: |
            # Verificar conectividad SSH
            echo "Verificando conexión SSH..."
            whoami
            hostname

            # Crear directorio si no existe
            mkdir -p /opt/atletismo-bot

            # Cambiar al directorio del proyecto
            cd /opt/atletismo-bot

            # Respaldar base de datos si existe
            if [ -f data/bot.db ]; then
              cp data/bot.db data/bot.db.backup.$(date +%Y%m%d_%H%M%S)
            fi

            # Limpiar directorio (excepto data/)
            find . -maxdepth 1 ! -name 'data' ! -name '.' -type f -delete
            find . -maxdepth 1 ! -name 'data' ! -name '.' -type d -exec rm -rf {} + 2>/dev/null || true

            # Clonar el código desde GitHub
            git clone --depth 1 --branch production https://github.com/${{ github.repository }} . || git pull origin production

            # Instalar Python si no está disponible
            if ! command -v python3.11 &> /dev/null; then
              apt update
              apt install -y software-properties-common
              add-apt-repository -y ppa:deadsnakes/ppa
              apt install -y python3.11 python3.11-venv python3.11-pip
            fi

            # Crear entorno virtual si no existe
            if [ ! -d "venv" ]; then
              python3.11 -m venv venv
            fi

            # Activar entorno virtual e instalar dependencias
            source venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt

            # Crear archivo .env con las variables de entorno
            cat > .env << EOF
            # Configuración del bot (desde GitHub Secrets)
            TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
            ADMIN_USER_ID=${{ secrets.ADMIN_USER_ID }}

            # Base de datos
            DATABASE_URL=sqlite+aiosqlite:///./data/bot.db

            # Logging
            LOG_LEVEL=INFO
            LOG_FORMAT=text
            EOF

            # Asegurar permisos correctos para .env
            chmod 600 .env

            # Crear directorio data si no existe
            mkdir -p data

            # Inicializar base de datos si no existe
            if [ ! -f data/bot.db ]; then
              source venv/bin/activate
              python -m src.database.engine
            fi

            # Crear archivo de servicio systemd si no existe
            if [ ! -f /etc/systemd/system/atletismo-bot.service ]; then
              cat > /etc/systemd/system/atletismo-bot.service << EOF
            [Unit]
            Description=Bot de Atletismo Madrid
            After=network.target

            [Service]
            Type=simple
            User=root
            WorkingDirectory=/opt/atletismo-bot
            ExecStart=/opt/atletismo-bot/venv/bin/python -m src.main
            Restart=always
            RestartSec=5
            Environment=PYTHONPATH=/opt/atletismo-bot

            [Install]
            WantedBy=multi-user.target
            EOF

              # Recargar systemd y habilitar el servicio
              systemctl daemon-reload
              systemctl enable atletismo-bot
            fi

            # Detener el servicio actual si está corriendo
            systemctl stop atletismo-bot || true

            # Iniciar el servicio
            systemctl start atletismo-bot

            # Verificar que el servicio esté corriendo
            systemctl status atletismo-bot --no-pager

            # Mostrar logs recientes
            journalctl -u atletismo-bot -n 20 --no-pager
